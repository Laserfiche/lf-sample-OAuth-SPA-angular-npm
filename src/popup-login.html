<head>
  <script src="https://cdn.jsdelivr.net/npm/zone.js@0.11.4/bundles/zone.umd.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/@laserfiche/lf-ui-components@15/cdn/lf-ui-components.js"
    defer
  ></script>
  <script type="module">
    "use strict";
    import config from './config.js';

    function setRedirectUri(isLogoutFlow, loginComponent) {
      console.log("redirect URI is ,", config.REDIRECT_URI + '/popup-login.html' + (isLogoutFlow ? '?a=tennis' : ''));
      loginComponent.setAttribute(
        'redirect_uri',
          config.REDIRECT_URI + '/popup-login.html' + (isLogoutFlow ? '?a=sso-logout-completed' : '')
      );
    }

    function addLoginComponent() {
      const loginComponent = document.createElement('lf-login');

      if (document.location.href.includes("code=")) {
        setRedirectUri(false, loginComponent);
      }
      loginComponent.setAttribute('scope', config.SCOPE);
      loginComponent.setAttribute('authorize_url_host_name', config.HOST_NAME);
      loginComponent.setAttribute('client_id', config.CLIENT_ID);
      loginComponent.setAttribute('redirect_behavior', 'Replace');
      loginComponent.setAttribute('id', 'login-component');
      loginComponent.setAttribute('style', 'display: none');
      document.body.appendChild(loginComponent);
    }

    window.onload = () => {
      addLoginComponent();

      const element = document.getElementById('login-component');
      const loginbutton = element.querySelector('.login-button');
      element.addEventListener('loginCompleted', () => {
        window.close();
      });

      const closeAfterLogout = document.location.href.includes('sso-logout-completed');

      if (document.location.href.includes("code=")) {
        console.log("Login completed with current state: ", element.state);
      } else if (closeAfterLogout) {
        // Close popup window after logout
        window.close();
      } else if (element.state === 'LoggedOut') {
        // Start the login flow
        setRedirectUri(false, element);
        element.initLoginFlowAsync();
      } else { 
        // Start the logout flow by clicking on the login-button on the lf-login component
        setRedirectUri(true, element);
        loginbutton.click(); 
      }
    };
  </script>
  <link
    href="https://cdn.jsdelivr.net/npm/@laserfiche/lf-ui-components@15/cdn/lf-laserfiche-lite.css"
    rel="stylesheet"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/@laserfiche/lf-ui-components@15/cdn/indigo-pink.css"
    rel="stylesheet"
  />
</head>
